\ EMPTY
REQUIRE %vfxland5%/supershow/actor.vfx
REQUIRE %vfxland5%/supershow/stage.vfx
REQUIRE %vfxland5%/supershow/sprites.vfx

REQUIRE %vfxland5%/cjson/cjson.vfx
REQUIRE %idir%/tiled.vfx

builtin-font fnt! \ TODO: where to call this??

2VARIABLE scrollx
scrollx cell+ CONSTANT scrolly

: bound-ofs ( array - n )
    scrollx 2@ 2>i xgap ygap 2/ tmw * +  swap #items umod ;

: _torg ( - a )
    ta @` dup bound-ofs` nth ;

: _scroll ( - )
    scrollx 2@ 2>i xgap ygap 2mod 2negate +at ;

%tilemap :: draw ( - )
    <at
    ts @ >baseid @ pile!
    _scroll
    gamew >p xgap / p>f roundup f>s 1 + 
    gameh >p ygap / p>f roundup f>s 1 +
    w 2@ 2min
    _torg` -rot ( a cols rows ) drawbg ;


JSONFILE %idir%/dungeon/dungeon.tmj

dungeon.tmj "dungeon_background" TILEMAP-FROM layer0.tm
dungeon.tmj "dungeon_platform" TILEMAP-FROM layer1.tm
dungeon.tmj "dungeon_details" TILEMAP-FROM layer2.tm
dungeon.tmj "dungeon_front" TILEMAP-FROM layer3.tm

bitmap assets/blobby.png \ TODO: Load automatically from image-collection tileset

class: %blobby 
    %actor derive
    template { blobby.png bmp ! }
class;

dungeon.tmj "objects" load-to-stage

: dungeon
    work>
        <left> held? if -2. scrollx +! then
        <right> held? if 2. scrollx +! then
        <up> held? if -2. scrolly +! then
        <down> held? if 2. scrolly +! then
    show>
        0 0 at
        layer0.tm draw
        layer1.tm draw
        layer2.tm draw
        m{ 
            scrollx 2@ 2negate 2p>f 1e 1e 0e transform
            sprites
        m}
        {{
            gamew gameh 2 2 2/ at blobby.png put
        }}
        layer3.tm draw 
        0 0 at s{ scrollx 2@ 2>i swap . . s} print
;

dungeon