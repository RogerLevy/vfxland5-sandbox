REQUIRE %vfxland5%/supershow/tileset.vfx
REQUIRE %vfxland5%/supershow/tilemap3.vfx

public 

2VARIABLE scrollx
scrollx cell+ CONSTANT scrolly

: _bound-ofs ( array - n )
    scrollx 2@ 2>i xgap ygap 2/ tmw * +  ta @ #items umod ;

borrow array3>> slot
: _torg ( - a )
    _bound-ofs ta @ slot ;

: _tscroll ( - )
    scrollx 2@ 2>i xgap ygap 2mod 2negate +at ;

REDEF %tilemap :: draw ( - )
    <at
    ts @ >baseid @ pile!
    _tscroll
    gamew >p xgap / p>f roundup f>s 1 + 
    gameh >p ygap / p>f roundup f>s 1 +
    w 2@ 2min
    _torg` -rot ( a cols rows ) drawbg ;

: _scroll ( - )
    scrollx 2@ 2pfloor 2negate 2p>f 1e 1e 0e transform ;

REDEF : backsprites
    m{ _scroll backsprites m} ;

REDEF : sprites
    m{ _scroll sprites m} ;
