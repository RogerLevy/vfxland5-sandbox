REQUIRE %idir%/mind.vfx
REQUIRE %idir%/microcodes.vfx
REQUIRE %vfxland5%/supershow/stage.vfx
REQUIRE %idir%/painter.vfx
REQUIRE %idir%/togglebox.vfx

BITMAP %idir%/owl.png
BITMAP %idir%/roger.png
roger.png 16 16 TILESET-FROM roger.ts

: 2x  2 user-zoom ! ;
: 3x  3 user-zoom ! ;

: paint ( bmpid - )
    mouse at *paint hud push ;

: *kpress ( key xt - ability )
    %ability add { kp ! k ! me } ;

c: %gravity %move [non-decaying] ;
%gravity >template { 90. ang ! 0.03 acc ! }

c: %rando %origin startx starty ;
0 %rando :construct micro:construct x 2@ startx 2! ;

: *rando
    %rando add {{
        \ 0 ICON_SPACING at
        <del> [: me unload ;] *kpress {{ }}
        <enter> [: startx 2@ x 2! ;] *kpress {{ }}   \ couples this to a rando
        \ %gravity add { }
        %move add {{ 
            %rep add {{
                [: 1.0 val ! 360. rnd ang ! ;] xt !
                %ability add {{
                    <enter> k !
                    [: 0. val ! ;] kp !
                    [: 1. val ! dur @ t ! ;] kr !
                }}
            }}
            %ability add {{
                <enter> k !
                [: 1. val ! ;] kh !
            }}
        }}
        %micro add {{
            %micro add {{ }}
        }}
    me }} ;

: *sprite ( bmp - sprite )
    %sprite add { bmp ! me } ;

\ -- Viewport (experimental) ---------------------------------------------------

class: %viewport %ui-box derive
    works-with %_micro
    prop xt :xt
    prop active <readonly

    :: on-focus  active on ;
    :: on-blur   active off ;

    :: _mousedown 
        lmb = -exit
        <space> held? ?exit
        me focus ;

    :: _draw
        abspos 2>i zoom @ dup 2*``
        w 2@ 2>i zoom @ dup 2*`` al_set_clipping_rectangle 
        cls 
        xt @ dup if catch dup if nip then then
        0 0 winw winh al_set_clipping_rectangle 
        throw ;

class;

: *viewport ( w h - viewport )
    %viewport add { 2>p w 2! me } ;

\ -- Test ----------------------------------------------------------------------

machines {{
    64 64 at 
    \ *rando {{
    \     *rando {{ }}
    \ }}
    100 230 at
    %origin add {{ 
        50. 50. rx 2!
        e{ 
            64 -64 at 
            %origin add {
                -8 -8 at
                %hitbox add {{ }}                 
                0 0 at 
                owl.png *sprite { } 
                roger.ts 0 tile *sprite { } 
            }
        e}
        -50 0 +at
        %move add {{ 
            0.9 dcy !
            %rng add {{ 
                en off
                \ noi on
                %rep add {{ }}
            }}
        }}
        %move add {{ 
            0.9 dcy !
            90. ang !
            %rng add {{
                en off 
                \ noi on 
                %rep add {{ }}
            }}
        }}
        %ability add {{ }}
        %rep add {{ }}
        %timeout add {{ }}
        %neuron add {{ 
            %rng add {{
                0.2 val !
                noi on
            }}
            \ %rep add {{ 
            \     trg off
            \     0.2 dur ! 
            \     [: 0.4 val +! ;] xt !
            \ }}

        }}        
    }}
}}


160 20 at 
%panel make constant panel
panel machines unshift
panel {
    250. 150. w 2!
    10 10 at
    white
    s" Hello, my baby!" *label constant label
    0 16 +at 
    123 *int redef constant int
    0 16 +at 
    123.0 *fixed redef constant fixed

    0 16 +at 
    s" x: " *label drop
    32 0 +at
    0 *fixed constant fixed-x
    panel >x fixed-x >ra !

    -32 16 +at 
    s" y: " *label drop
    32 0 +at
    0 *fixed constant fixed-y
    panel >y fixed-y >ra !

    -32 16 +at
    s" rnd32 $ff or machines >clr !" *command drop

    0 16 +at
    150 *repl drop 
}

\ panel inspect

\ -- Viewport Test -------------------------------------------------------------

400 150 at  320 240 *viewport { 
    [: red screen  at-me  machines { <at me render } ;] xt !
    me inspect
} 

include %idir%/dungeon/main.vfx
micros \ re-establish main loop

50 250 at  320 240 *viewport { 
    memoize-include %idir%/init-scene-viewport.vfx
} 


class: %owl
    %actor derive
class;


\ -- Menu Test -----------------------------------------------------------------

\ 10 120 at *menu {
\     me [: 1 . me .summary cr ;] s" Menu item 1" option
\     me [: 2 . me .summary cr ;] s" Menu item 2" option
\     me [: 3 . me .summary cr ;] s" Menu item 3" option
\ }

\ -- Instructions---------------------------------------------------------------

cr
cr
." Controls: " cr
."  LMB: click/drag" cr
."  Shift+RMB: inspect" cr
."  Del: delete selected" cr

fullscreen winmode >vfx

load-all
['] close hud each 