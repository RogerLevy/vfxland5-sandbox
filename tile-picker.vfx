REQUIRE %idir%/painter.vfx

class: %tile-picker
    %element derive
    prop ts :ref %tileset
    prop tile#
    prop clr 
    template { $c0 clr ! }
    
    || : the-bmp  ts @ dup if >bmp @ then ;
    || : the-tile  ts @ dup if tile# @ tile then ;

    :: click-box@
        abspos
        the-bmp bmpwh or 0= if 16 16 else the-bmp bmpwh then
        2>p box ;

    :: _process
        using? bolted? not or -exit
        me hovered = -exit
        lmb held? <space> held? not and if
            pmouse abspos 2- 2>i ts @ xy>tile tile# !
            ?painter ?dup if the-tile swap select then
        then ;

    :: _draw
        me click-box@ 2over 2- 2swap atp
        clr @ rgba8 rectf
        the-bmp put
        the-tile bmpxy +at  
        ts @ >tw 2@ 2>p white rect
        \ the-bmp id>bmp ?dup -exit >touched @ if  
            e{ me click-box@ 2over 2- 2swap atp white 0.25 ppena! rect e} 
        \ then 
        \ ?painter ?dup if white-connector then ;
        ;

    :: forth@ ( - a len )
        ts @ body>name f" %s ts !" ;

class;

: *tile-picker ( tileset - tile-picker )
    %tile-picker *add { ts ! me } ;

\ : ?tile-picker ( bmpid - )
\     dup is-subbmp? if dup bmp>ts *tile-picker { me click-dims drop  negate 0 x 2! } then
\     drop ;