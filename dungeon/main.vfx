builtin-font fnt! \ TODO: where to call this??

REQUIRE %vfxland5%/supershow/actor.vfx
REQUIRE %vfxland5%/supershow/stage.vfx
REQUIRE %vfxland5%/supershow/sprites.vfx
REQUIRE %vfxland5%/supershow/mode.vfx

REQUIRE %vfxland5%/cjson/cjson.vfx
REQUIRE %idir%/../tiled.vfx
REQUIRE %idir%/../scrolling.vfx

JSONFILE %idir%/dungeon.tmj

CLASS: %level
    IS-A %drawable
    PROP layers :ref %array
    PROP sprlayer#
    PROP bsprlayer# 
    template { 1 sprlayer# ! }

    :: draw ( - )
        0 
        [:  over bsprlayer# @ = if backsprites then
            over sprlayer# @ = if sprites then
            0 0 at draw  1 + 
        ;] layers @ each
        dup bsprlayer# @ = if backsprites then
        sprlayer# @ = if sprites then ;
CLASS;

: LEVEL  ( tmj <name> <layernames>- )
    \ layers need to be listed in reverse order (TODO: fix??)
    {: tmj | cnt zbuf[ 256 ] :}
    0 to cnt
    create %level dmake { 
        begin bl parse dup while
            zbuf[ zplace 
            save-input n>r
            tmj zbuf[ *tilemap-from ( add to stack )
            nr> restore-input drop
            1 +to cnt
        repeat ." done" cr 2drop
        cell array{ >r
            cnt for , loop 
        r> array} layers !
    } ;

dungeon.tmj LEVEL dungeon.lvl  front details platform background 
3 dungeon.lvl >sprlayer# !


BITMAP assets/blobby.png \ TODO: Load automatically from image-collection tileset

CLASS: %blobby 
    %actor derive
    template { blobby.png bmp ! }
CLASS;

ec-cell lvl

: dungeon
    dungeon.tmj "objects" load-to-stage
    dungeon.lvl lvl! ;

: game
    work>
        <left> held? if -2. scrollx +! then
        <right> held? if 2. scrollx +! then
        <up> held? if -2. scrolly +! then
        <down> held? if 2. scrolly +! then
    show>
        lvl@ draw
        0 0 at s{ scrollx 2@ 2>i swap . . s} print
;

dungeon game