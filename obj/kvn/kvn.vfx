bitmap %idir%/kvn.png
kvn.png 8 8 tileset-from kvn.ts

: normal-hitbox  -3 -3 6 7 solidity-hitbox! ;
: falling-hitbox -3 -4 6 5 solidity-hitbox! ;

class: %kvn
    %actor derive
    is-a %platformer
    prop fd :fixed  \ fall distance

    template { 
        normal-hitbox
        .12 gravity !
        1.5 terminal-vy !
        1.55 jump-power !
        .09 rise-power !
        .75 walk-speed !
        .75 terminal-vx !
        .08 air-control !
    }
class;

kvn.ts animation walk.anm    0 11 range,
kvn.ts animation jump.anm    46 frame,
kvn.ts animation climb.anm   34 45 range,
kvn.ts animation fall.anm    12 13 range,
kvn.ts animation splat.anm   14 33 range,

\ Animation
\ : ?footstep  a.done @ if 0.7 loud *beep16* a.done off then ;
: movelegs  vx @ abs 2 / vx @ abs 0.15 >= if 0.1 + then .75 min a.spd ! ; \ ?footstep ;
: ?walkanm  anm @ walk.anm <> if walk.anm 0 cycle then ;
: ?idleanm  anm @ walk.anm = if 0 a.spd ! then  ?walkanm ;

\ Collect items
\ : ?collect
\     -4 -4 8 8 map@ tread> 
\         dup @ | t a |
\         t collectible? if t ?item 2dup type evaluate cr 0 a ! then ;

\ Pit death
: ?pit  y @ vy @ + gameh >p > if halt phys off die then ;
: ?ubk  y @ vy @ + 8. < if halt phys off die then ;

\ Spikes death
: ?spikes
    falling @ -exit
    0 0 +tile@ instakill? -exit
    die ;

\ Common physics
: common-physics  ( ?travel ?collect ?pit ) ?ubk ?spikes ;

\ Plummeting (lose control, splat if fall too far)
\ : splat
\     0 fd ! 
\     -collisions
\     0 0 vx 2!
\     splat.anm 0.25 cycle
\     *beep10*
\     act> a.done @ -exit anm off
\     act> 1.0 passed? -exit die ;

: plummet-physics 
    platformer-physics common-physics
    vy @ fd +!
    ground? if
        \ fd @ 112. >= if
        \     splat
        \ else
            \ LAND is already called
            normal-hitbox
            -4. y +!
        \ then
    then ;

\ : plummet
\     ." plummet " cr
\     falling-hitbox
\     fall.anm 0.25 cycle 
\     *beep13*
\     act> physics> plummet-physics ;

\ : ?plummet
\     falling @ -exit
\     vy @ fd +!  fd @ 68. >= -exit
\     plummet ;


\ Normal Physics
: kvn-physics  platformer-physics common-physics ( ?plummet ) ; 

\ Sound
\ : land-sound  sfx @ [&] *beep13* -> id @ = if 0 sfx ! then *beep12* ;

\ Logic
class: %kvn
    :: >climb platformer:>climb climb.anm 0 cycle ;
    :: kill   me unload vanish "death" gevent bail ;
    :: >jump  platformer:>jump jump.anm 1. cycle "*jump*" gevent ;
    :: >walk  platformer:>walk ?walkanm +act> movelegs ;
    :: >idle  platformer:>idle ?idleanm +act> movelegs ;
    :: >fall  platformer:>fall jump.anm 1. cycle 0 fd ! ;
    :: >land  platformer:>land ( land-sound ) physics> kvn-physics ;
    :: init   playable /platformer physics> kvn-physics ;
class;